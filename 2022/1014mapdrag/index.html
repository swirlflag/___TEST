<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js" integrity="sha512-WoO4Ih0CDOSLYafy22wZD/mcJ7k0ESLqtQsFa6zFKnEUrbtuGU+GkLtVhgt93xa2qewG5gKEC6CWlN8OaCTSVg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.3/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.3/ScrollToPlugin.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css" />
<title>Document</title>
<link rel="stylesheet" href="./style.css">
</head>
<body>

<div id="app">

    <div class="cursor">
        <span class="cursor__pointer">
            <span class="cursor__visual"></span>
        </span>
    </div>

    <div class="float-nav">
        <ul>
            <li><button class="-active">월드맵</button></li>
            <li><button>티저 영상</button></li>
        </ul>
    </div>

    <div id="page-plate">
        <section class="section--map">
            <div class="worldmap">
                <div class="focuscrosshead">
                    <span>hello</span>
                </div>
                <div class="mappoints"></div>
                <canvas></canvas>
            </div>
        </section>
        <section class="section--video">
            <div class="sourcebox">
                <video src="https://pvi.dn.nexoncdn.co.kr/prasia/map_prototype/testvideo.mp4" autoplay muted playsinline loop></video>
            </div>
        </section>
    </div>

    <div id="modal-plate">
        <div class="modal-item type--video">
			<span class="modal__dimmed"></span>
			<div class="modal-item__wrap">
				<div class="modal__box">
					<button class="modal__close">닫기</button>
					<div class="modal__content">
						<div class="sourcebox">
							<video src="https://pvi.dn.nexoncdn.co.kr/prasia/map_prototype/testvideo2.mp4" autoplay muted playsinline loop></video>
						</div>
					</div>
				</div>
			</div>
		</div>
    </div>
</div>

<script src="./script.js"></script>
<script>

if ('scrollRestoration' in history) {
    history.scrollRestoration = 'manual';
}

const YOUTUBE_KEY = "m8Ll-uML7Z4?start=14";
const $modalVideo = document.querySelector(".modal-item.type--video");
window.modal = {};
window.modal.video = new ModalObjectVideo($modalVideo, {youtube: YOUTUBE_KEY});

const perRound = (value) => {
    return (Math.round(value * 1000))/10;
}

const $app = document.querySelector("#app");
const $page = $app.querySelector("#page-plate");
const $sections = $app.querySelectorAll("section");
const $canvas = $app.querySelector(".worldmap canvas");
const ctx = $canvas.getContext("2d");
const mapSource = new Image();

const $mappoints = $app.querySelector(".mappoints");

const $crosshead = $app.querySelector(".focuscrosshead");
const $crossheadtext = $app.querySelector(".focuscrosshead span");
const $floatnav = $app.querySelector(".float-nav");
const $floatnavItems = $floatnav.querySelectorAll("ul li button");

const store = new StoreComponent({
    sectionIndex: 0,
    pointFocusIndex: -1,
    isSectionMoving: false,
    isPointFocusing: false,
},{proxy: true});

mapSource.src = "./map.jpg";

mapSource.onload = () => {
    focus.width = mapSource.width * focus.scale;
    focus.height = mapSource.height * focus.scale;
    map.width = focus.width;
    map.height = focus.height;

    ctx.canvas.width = size.ww;
    ctx.canvas.height = size.wh;

    setScale(focus.scale);
    setFocusPercent(50,50);
};

const size = {
    ww : window.innerWidth,
    wh : window.innerHeight,
    cx : window.innerWidth/2,
    cy : window.innerHeight/2,
};

const defaultValue = {
    mapPower: 0.25,
    cursorPower: 0.35,
    initScale: 0.1,
    limitCloseoutScale: 0.7,
    limitCloseupScale: 1.4,
    focusScale: 2.7,
};

const map = {
    x: 0,
    y: 0,
    scale: defaultValue.initScale,
    width: 0,
    height: 0,
    power: defaultValue.mapPower,
}

const focus = {
    x: 0,
    y: 0,
    scale: defaultValue.initScale,
    width: 0,
    height: 0,
    xPercent: 50,
    yPercent: 50,
    xPercentMap :50,
    yPercentMap :50,
    isFreeze: false,
};

const mouse = {
    x: 0,
    y: 0,
};

const cursor = {
    x: 0,
    y: 0,
    power: defaultValue.cursorPower,
}

const press = {
    isPress: false,
    time: 0,
    timer: null,

    startFocusX : 0,
    startFocusY : 0,
    startPressX: 0,
    startPressY: 0,
    moveX: 0,
    moveY: 0,
}








window.addEventListener("resize", () => {
    size.ww = window.innerWidth;
    size.wh = window.innerHeight;
    size.cx = window.innerWidth/2;
    size.cy = window.innerHeight/2;

    ctx.canvas.width = size.ww;
    ctx.canvas.height = size.wh;

    // setFocusPercent(focus.xPercent, focus.yPercent);
    // setFocusMapPercent(focus.xPercent, focus.yPercent);
    // setFocusMapPercent(14,42.5);
    // setFocusMapPercent(20,42.5);

    setFocusMapPercent(focus.xPercentMap, focus.yPercentMap);
    // setScale(focus.scale);

});

const pressDown = (e) => {
    if(focus.isFreeze) {
        return;
    }

    for(let i = 0, l = e.path.length; i < l; ++i) {
        const isWorldmap = e.path[i].classList?.contains('worldmap');
        if(isWorldmap) {
            break;
        }
        if(i === e.path.length -1 ) {
            return;
        }
    }

    press.isPress = true;
    press.startPressX = e.clientX;
    press.startPressY = e.clientY || e.touches[0].clientY;
    press.startFocusX = focus.x;
    press.startFocusY = focus.y;
};
const pressMove = (e) => {
    if(!press.isPress) {
        return;
    }
    if(focus.isFreeze) {
        return;
    }

    press.moveX = e.clientX;
    press.moveY = e.clientY;

    const dx = press.moveX - press.startPressX;
    const dy = press.moveY - press.startPressY;

    const x = press.startFocusX - dx;
    const y = press.startFocusY - dy;

    const dmax = Math.max(Math.abs(dx),Math.abs(dy));
    if(dmax > 300 && store.isPointFocusing) {
        store.setState("pointFocusIndex" , -1);
        pressDown(e);
        return;
    }

    setFocus(x,y);

};
const pressUp = () => {
    press.isPress = false;
    press.moveX = 0;
    press.moveY = 0;
    press.startFocusX = 0;
    press.startFocusY = 0;
};

window.addEventListener("mousedown", (e) => {
    pressDown(e);
});
window.addEventListener("mousemove", (e) => {
    pressMove(e);
});
window.addEventListener("mouseup", (e) => {
    pressUp();
});
window.addEventListener("mouseout", (e) => {
    // pressUp();
});

window.addEventListener("touchstart", (e) => {
    pressDown(e.touches[0]);
});
window.addEventListener("touchmove", (e) => {
    pressMove(e.touches[0]);
});
window.addEventListener("touchend", (e) => {
    pressUp();
});

const setFocus = (willX, willY) => {

    willX = willX === undefined ? focus.x : willX;
    willY = willY === undefined ? focus.y : willY;

    let isOverX = focus.width - willX - size.ww < 0;
    let isOverY = focus.height - willY - size.wh < 0;

    let limitX = focus.width - size.ww - 1;
    let limitY = focus.height - size.wh - 1;

    let x = willX;
    let y = willY;

    if(willX <= 0) {
        x = 0;
    }
    if(isOverX) {
        x = limitX;
    }

    if(willY <= 0) {
        y = 0;
    }
    if(isOverY) {
        y = limitY;
    }

    focus.x = Math.round(x);
    focus.y = Math.round(y);

    const xPercent = perRound(focus.x / (focus.width - size.ww));
    const yPercent = perRound(focus.y / (focus.height - size.wh));
    focus.xPercent = xPercent;
    focus.yPercent = yPercent;

    const xPercentMap = perRound((focus.x + size.cx) / (focus.width));
    const yPercentMap = perRound((focus.y + size.cy) / (focus.height));
    focus.xPercentMap = xPercentMap;
    focus.yPercentMap = yPercentMap;

    $crossheadtext.innerHTML = `focus<br>x: ${focus.x} (${xPercent}%)<br>y: ${focus.y} (${yPercent}%)`;
};

const setFocusPercent = (xPercent, yPercent) => {
    const x = (focus.width - size.ww)/100 * xPercent;
    const y = (focus.height - size.wh)/100 * yPercent;
    setFocus(x,y);
};

const setFocusMapPercent = (xPercent, yPercent) => {
    const x = focus.width/100 * xPercent - size.cx;
    const y = focus.height/100 * yPercent - size.cy;
    setFocus(x,y);
};

const setScale = (scale, power) => {

// [TODO] 항좀 정리하자 
    scale = scale <= 0.001 ? 0.001 : scale;

    const origin = {
        x: 1/focus.scale * focus.x,
        y: 1/focus.scale * focus.y,
    };

    origin.x = origin.x - (size.cx - (1/focus.scale * size.cx));
    origin.y = origin.y - (size.cy - (1/focus.scale * size.cy));

    if(mapSource.width * scale < size.ww) {
        scale = (size.ww+1) / (mapSource.width);
    }
    if(mapSource.height * scale < size.wh) {
        scale = (size.wh+1) / (mapSource.height);
    }

    let x = ((origin.x - size.cx/scale) * scale) + (size.cx * scale);
    let y = ((origin.y - size.cy/scale) * scale) + (size.cy * scale);

    focus.scale = scale;
    focus.width = mapSource.width * scale;
    focus.height = mapSource.height * scale;
    focus.x = x;
    focus.y = y;
}

window.addEventListener("mousewheel" , (e) => {
    return;

    if(e.deltaY > 0) {
        // 축소
            setScale(focus.scale - 0.05);
        // if(focus.scale > defaultValue.limitCloseoutScale) {
        // }
    }else {
        // 확대
        if(focus.scale < defaultValue.limitCloseupScale) {
            setScale(focus.scale + 0.05);
        }
    }

    setFocus();
});

window.addEventListener("mousewheel", (e) => {
    if(store.isSectionMoving) {
        return;
    }
    const direction = e.deltaY > 0;
    let nextIndex = store.sectionIndex;

    if(direction) {
        nextIndex = nextIndex + 1 <= $sections.length ? $sections.length - 1 : nextIndex + 1;
    }else {
        nextIndex = nextIndex - 1 <= -1 ? 0 : nextIndex - 1;
    }
    store.setState("sectionIndex", nextIndex, {exact: true});
});

[...$floatnavItems].forEach((button,i) => {
    button.addEventListener("click", () => {
        if(store.isSectionMoving) {
            return;
        }
        store.setState("sectionIndex", i);
    });
});

store.watch("sectionIndex", (now) => {

    [...$floatnavItems].forEach((button,i) => {
        button.classList[now === i ? "add" : "remove"]("-active");
    });

    store.setState("isSectionMoving", true);

    gsap.to(window, {scrollTo: $sections[now], ease: "power3.out", duration: 0.6, onComplete: () => {
        store.setState("isSectionMoving", false);
    }});

});



const drawMap = () => {

    const d = {
        x: focus.x - map.x,
        y: focus.y - map.y,
        scale: focus.scale - map.scale,
    };

    const x = map.x + (d.x * map.power);
    const y = map.y + (d.y * map.power);
    const scale = map.scale + (d.scale * map.power);

    map.x = x;
    map.y = y;
    map.scale = scale;

    map.width = mapSource.width * map.scale;
    map.height = mapSource.height * map.scale;

    $mappoints.style.transform = `translate3d(${-x}px,${-y}px,0)`
    $mappoints.style.width = `${map.width}px`;
    $mappoints.style.height = `${map.height}px`;

    ctx.drawImage(mapSource, -map.x, -map.y, map.width , map.height);
};


















// 대충만들고
// cursor
const $cursor = document.querySelector(".cursor");
const $cursorPointer = document.querySelector(".cursor__pointer");
const $cursorVisual = document.querySelector(".cursor__visual");

window.addEventListener("mousemove", (e) => {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
    for(let i = 0, l = e.path.length; i < l; ++i) {
        if(e.path[i].tagName === "A" || e.path[i].tagName === "BUTTON") {
        // console.log('hoveR!');
            $cursor.classList.add("-hover");
            break;
        }
        $cursor.classList.remove("-hover");
    }
});
window.addEventListener("mousedown" , () => {
    $cursor.classList.add("-press");
});
window.addEventListener("mouseup" , () => {
    $cursor.classList.remove("-press");
});

const drawCursor = () => {
    const dx = mouse.x - cursor.x;
    const dy = mouse.y - cursor.y;

    const x = (cursor.x + (dx * cursor.power));
    const y = (cursor.y + (dy * cursor.power));

    cursor.x = x;
    cursor.y = y;

    $cursorPointer.style.transform = `translate3d(${x}px,${y}px,0)`;
};

const draw = () => {
    requestAnimationFrame(draw);
    drawMap();
    drawCursor();
};

draw();

const myPoints2 = [
    {
        name: "화산섬 아래 반도",
        text: "Nullam rutrum elit nec neque tristique, ac",
        coord: [46,35],
    },
    {
        name: "말라붙은 계곡",
        text: "uspendisse commodo velit in tincidunt sagittis.",
        coord: [46,54],
    },
    {
        name: "산맥 정상",
        text: "Quisque est orci, efficitur in pellentesque id,",
        coord: [64,58],
    },
    {
        name: "남대륙 만",
        text: "Praesent odio tellus, condimentum a sollicitudin ut,",
        coord: [53,76],
    },
    {
        name: "사막산 정상",
        text: "pretium ut est. Praesent pharetra vestibulum egestas.",
        coord: [35,53],
    },
];
// <i class="fa-solid "></i>
let template_mappoint = ``;
[...myPoints2].forEach((point,i) => {
    template_mappoint += `
        <div class="point point--${i}" style="left:${point.coord[0]}%;top:${point.coord[1]}%">
            <button>${point.name}</button>
            <div>
                <p>${point.text}</p>
                <i class="fa fa-video"></i>
                <i class="fa fa-forward"></i>
                <i class="fa fa-window-close"></i>
            </div>
        </div>
    `;
});
$mappoints.innerHTML = template_mappoint;

const $mappoint_itmes = document.querySelectorAll(".mappoints .point");

[...$mappoint_itmes].forEach((item,i) => {

    const $button = item.querySelector("button");
    const $video = item.querySelector("i.fa-video");
    const $next = item.querySelector("i.fa-forward");
    const $close = item.querySelector("i.fa-window-close");

    $button.addEventListener("click", () => {
        store.setState("pointFocusIndex", i);
    });

    $video.addEventListener("click" , () => {
        modal.video.open();
    });

    $next.addEventListener("click" , () => {
        const nextIndex = store.pointFocusIndex + 1 >= myPoints2.length ? 0 : store.pointFocusIndex + 1;
        store.setState("pointFocusIndex", nextIndex);
    });

    $close.addEventListener("click" , () => {
        store.setState("pointFocusIndex", -1);
    });

});

store.watch("pointFocusIndex", (now,prev) => {

    if(now < 0) {
        store.setState("isPointFocusing", false);
        map.power = defaultValue.mapPower;
        setScale(defaultValue.limitCloseoutScale);
        setFocus();
        $canvas.classList.remove("-perspective");
        return;
    }

    store.setState("isPointFocusing", true);
    map.power = 0.05;
    setScale(2);
    setFocusMapPercent(...myPoints2[now].coord);
    // $mappoint_itmes[now].classList.add("-active");
    setTimeout(() => {
        modal.video.open({onClose : () => {
            store.setState("isPointFocusing", false);
            map.power = defaultValue.mapPower;
            setScale(defaultValue.limitCloseoutScale);
            setFocus()
        }});
    },500)
    $canvas.classList.add("-perspective");

    // $mappoint_itmes[prev] && $mappoint_itmes[prev].classList.remove("-active");

    // if(now < 0) {
    //     store.setState("isPointFocusing", false);
    //     map.power = defaultValue.mapPower;
    //     setScale(defaultValue.limitCloseoutScale);
    //     setFocus();
    //     $canvas.classList.remove("-perspective");
    //     return;
    // }

    // store.setState("isPointFocusing", true);
    // map.power = 0.13;
    // setScale(2);
    // setFocusMapPercent(...myPoints2[now].coord);
    // $mappoint_itmes[now].classList.add("-active");
    // $canvas.classList.add("-perspective");
});




window.addEventListener("DOMContentLoaded", () => {

    const tl_init = gsap.timeline({paused: true});
    // setScale(defaultValue.limitCloseoutScale);

    tl_init.fromTo(document.body, {autoAlpha: 0}, {autoAlpha: 1, duration: 1, ease: "power1.in"},0);

    tl_init.add(() => {

        setTimeout(() => {
            map.power = 1;
            setScale(defaultValue.initScale);
        },0);
        setTimeout(() => {
            map.power = 0.05;
            setScale(defaultValue.limitCloseoutScale);
        },100)
        setTimeout(() => {
            map.power = defaultValue.mapPower;
            focus.isFreeze = false;
        },1600);

    },0.2);

    tl_init.play();
    focus.isFreeze = true;
});


// dat
const guidev = {
    "중심 확인선 켜기": false,
    "직접 이동: 화산섬 아래 반도": () => {
        store.setState("pointFocusIndex", 0);
    },
    "직접 이동: 말라붙은 계곡": () => {
        store.setState("pointFocusIndex", 1);
    },
    "직접 이동: 산맥 정상": () => {
        store.setState("pointFocusIndex", 2);
    },
    "직접 이동: 남대륙 만": () => {
        store.setState("pointFocusIndex", 3);
    },
    "직접 이동: 사막산 정상": () => {
        store.setState("pointFocusIndex", 4);
    },
};

const gui = new dat.GUI();
const guiclose = gui.domElement.querySelector(".close-button");
let isOpen = localStorage.guiopen ? true : false;
guiclose.addEventListener("click", () => {
    isOpen = !isOpen;
    if(isOpen) {
        localStorage.setItem("guiopen", isOpen);
    }else {
        localStorage.removeItem("guiopen");
    }
});
isOpen ? gui.open() : gui.close();

const gui_mouse = gui.addFolder("mouse");
gui_mouse.add(mouse, "x").listen();
gui_mouse.add(mouse, "y").listen();
// gui_mouse.domElement.style.pointerEvents = "none";
// gui_mouse.open();

const gui_cursor = gui.addFolder("cursor");
gui_cursor.add(cursor, "x").listen();
gui_cursor.add(cursor, "y").listen();
// gui_cursor.domElement.style.pointerEvents = "none";
// gui_cursor.open();

const gui_focus = gui.addFolder("focus");
gui_focus.add(focus, "x").listen();
gui_focus.add(focus, "y").listen();
gui_focus.add(focus, "xPercent").listen();
gui_focus.add(focus, "yPercent").listen();
gui_focus.add(focus, "xPercentMap").listen();
gui_focus.add(focus, "yPercentMap").listen();
gui_focus.add(focus, "scale").step(0.0001).listen();
gui_focus.add(focus, "width").step(1).listen();
gui_focus.add(focus, "height").step(1).listen();
// gui_focus.open();

const gui_map = gui.addFolder("map");
gui_map.add(map, "x").listen();
gui_map.add(map, "y").listen();
gui_map.add(map, "scale").step(0.0001).listen();
gui_map.add(map, "width").step(1).listen();
gui_map.add(map, "height").step(1).listen();
gui_map.add(map, "power").listen();
// guiMap.add(map, "width");
// guiMap.add(map, "height");
// gui_map.domElement.style.pointerEvents = "none";
// gui_map.open();

const gui_press = gui.addFolder("press");
gui_press.add(press, "isPress").listen();
gui_press.add(press, "time").listen();
gui_press.add(press, "startFocusX").listen();
gui_press.add(press, "startFocusY").listen();
gui_press.add(press, "startPressX").listen();
gui_press.add(press, "startPressY").listen();
gui_press.add(press, "moveX").listen();
gui_press.add(press, "moveY").listen();
// gui_press.domElement.style.pointerEvents = "none";
// gui_press.open();


const gui_cancontrol = gui.addFolder("조작 가능");
gui_cancontrol.add(guidev, "중심 확인선 켜기").onFinishChange((now) => {
    $crosshead.classList[now ? "add" : "remove"]("-show");
});
gui_cancontrol.add(guidev, "직접 이동: 화산섬 아래 반도");
gui_cancontrol.add(guidev, "직접 이동: 말라붙은 계곡");
gui_cancontrol.add(guidev, "직접 이동: 산맥 정상");
gui_cancontrol.add(guidev, "직접 이동: 남대륙 만");
gui_cancontrol.add(guidev, "직접 이동: 사막산 정상");
gui_cancontrol.open();


</script>
</body>
</html>
