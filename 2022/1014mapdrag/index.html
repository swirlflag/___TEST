<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js" integrity="sha512-WoO4Ih0CDOSLYafy22wZD/mcJ7k0ESLqtQsFa6zFKnEUrbtuGU+GkLtVhgt93xa2qewG5gKEC6CWlN8OaCTSVg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<title>Document</title>
<style>
* {
    margin: 0;
    padding: 0;
}
body {
    cursor: none;
}
#app {
    user-select: none;
}
.worldmap {
    position: fixed;
    left: 0; top: 0;
    width: 100%; height: 100%;
}
.worldmap canvas{
    position: relative;
    width: 100%; height: 100%;
    border: 1px solid #d3d;
    box-sizing: border-box;
}
.cursor {
    position: fixed;
    width: 0; height: 0;
    background-color: transparent;
    z-index: 3;
    pointer-events: none !important;
    /* mix-blend-mode: difference; */
}
.cursor.-press{

}
.cursor__pointer{
    display: inline-block;
    will-change: transform;
    left: 0; top: 0;
    position: absolute;
}
.cursor__visual{
    display: inline-block;
    width: 30px; height: 30px;
    border-radius: 9999px;
    display: inline-block;
    position: relative;
    top: -15px; left: -15px;
    border: 1px solid #fff;
    transition: transform 90ms ease;
    will-change: transform;
    overflow: hidden;
}
.cursor__visual::before{

}
.cursor.-press .cursor__visual {
    transform: scale(1.5);
}
.cursor.-press .cursor__visual::before{
    transform: scale(1);
}
.focuscrosshead {
    position: fixed;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 65;
    opacity: 0.8;
    user-select: none;
}
.focuscrosshead * {
    pointer-events: none !important ;
    user-select: none !important;
}
.focuscrosshead::before,
.focuscrosshead::after {
    content: "";
    position: absolute;
    display: inline-block;
    background-color: #d3d;
}
.focuscrosshead::before{
    width: 100%; height: 1px;
    top: 50%; left: 0;
}
.focuscrosshead::after{
    width: 1px; height: 100%;
    left: 50%; top: 0;
}
.focuscrosshead span{
    position: absolute;
    display: inline-block;
    top: 50%; left: 50%;
    color: #fff;
    background-color: #d3d;
}

</style>
</head>
<body>

<div id="app">
    <div class="focuscrosshead">
        <span>hello</span>
    </div>
    <div class="cursor">
        <span class="cursor__pointer">
            <span class="cursor__visual"></span>
        </span>
    </div>
    <div class="worldmap">
        <canvas></canvas>
    </div>
</div>

<script src="./script.js"></script>
<script>
const perRound = (value) => {
    return (Math.round(value * 1000))/10;
}

const canvas = document.querySelector(".worldmap canvas");
const ctx = canvas.getContext("2d");
const mapSource = new Image();

const focuscrosshead = document.querySelector(".focuscrosshead span");

mapSource.src = "./map.jpg";

mapSource.onload = () => {
    focus.width = mapSource.width;
    focus.height = mapSource.height;
    map.width = focus.width;
    map.height = focus.height;

    ctx.canvas.width = size.ww;
    ctx.canvas.height = size.wh;
};

const size = {
    ww : window.innerWidth,
    wh : window.innerHeight,
    cx : window.innerWidth/2,
    cy : window.innerHeight/2,
};

const map = {
    x: 0,
    y: 0,
    scale: 1,
    width: 0,
    height: 0,
    power: 0.13,
}

const focus = {
    x: 0,
    y: 0,
    scale: 1,
    width: 0,
    height: 0,
    xPercent: 0,
    yPercent: 0,
    xPercentMap :0,
    yPercentMap :0,
};

const mouse = {
    x: 0,
    y: 0,
};

const cursor = {
    x: 0,
    y: 0,
    power: 0.15,
}

const press = {
    isPress: false,
    time: 0,
    timer: null,

    startFocusX : 0,
    startFocusY : 0,
    startPressX: 0,
    startPressY: 0,
    moveX: 0,
    moveY: 0,
}

// dat
const gui = new dat.GUI();
const guiclose = gui.domElement.querySelector(".close-button");
let isOpen = localStorage.guiopen ? true : false;
guiclose.addEventListener("click", () => {
    isOpen = !isOpen;
    if(isOpen) {
        localStorage.setItem("guiopen", isOpen);
    }else {
        localStorage.removeItem("guiopen");
    }
});
isOpen ? gui.open() : gui.close();

const gui_mouse = gui.addFolder("mouse");
gui_mouse.add(mouse, "x").listen();
gui_mouse.add(mouse, "y").listen();
gui_mouse.domElement.style.pointerEvents = "none";
gui_mouse.open();

const gui_cursor = gui.addFolder("cursor");
gui_cursor.add(cursor, "x").listen();
gui_cursor.add(cursor, "y").listen();
gui_cursor.domElement.style.pointerEvents = "none";
gui_cursor.open();

const gui_focus = gui.addFolder("focus");
gui_focus.add(focus, "x").listen();
gui_focus.add(focus, "y").listen();
gui_focus.add(focus, "xPercent").listen();
gui_focus.add(focus, "yPercent").listen();
gui_focus.add(focus, "xPercentMap").listen();
gui_focus.add(focus, "yPercentMap").listen();
gui_focus.add(focus, "scale").step(0.0001).listen();
gui_focus.add(focus, "width").step(1).listen();
gui_focus.add(focus, "height").step(1).listen();
gui_focus.open();

const gui_map = gui.addFolder("map");
gui_map.add(map, "x").listen();
gui_map.add(map, "y").listen();
gui_map.add(map, "scale").step(0.0001).listen();
gui_map.add(map, "width").step(1).listen();
gui_map.add(map, "height").step(1).listen();
// guiMap.add(map, "width");
// guiMap.add(map, "height");
gui_map.domElement.style.pointerEvents = "none";
gui_map.open();

const gui_press = gui.addFolder("press");
gui_press.add(press, "isPress").listen();
gui_press.add(press, "time").listen();
gui_press.add(press, "startFocusX").listen();
gui_press.add(press, "startFocusY").listen();
gui_press.add(press, "startPressX").listen();
gui_press.add(press, "startPressY").listen();
gui_press.add(press, "moveX").listen();
gui_press.add(press, "moveY").listen();
gui_press.domElement.style.pointerEvents = "none";
gui_press.open();








window.addEventListener("resize", () => {
    size.ww = window.innerWidth;
    size.wh = window.innerHeight;
    size.cx = window.innerWidth/2;
    size.cy = window.innerHeight/2;

    ctx.canvas.width = size.ww;
    ctx.canvas.height = size.wh;

    // setFocusPercent(focus.xPercent, focus.yPercent);
    // setFocusMapPercent(focus.xPercent, focus.yPercent);
    // setFocusMapPercent(14,42.5);
    // setFocusMapPercent(20,42.5);

    setFocusMapPercent(focus.xPercentMap, focus.yPercentMap);
    // setScale(focus.scale);

});

const pressDown = (e) => {
    press.isPress = true;
    press.startPressX = e.clientX;
    press.startPressY = e.clientY || e.touches[0].clientY;
    press.startFocusX = focus.x;
    press.startFocusY = focus.y;
};
const pressMove = (e) => {
    if(!press.isPress) {
        return;
    }

    press.moveX = e.clientX;
    press.moveY = e.clientY;

    const dx = press.moveX - press.startPressX;
    const dy = press.moveY - press.startPressY;

    const x = press.startFocusX - dx;
    const y = press.startFocusY - dy;

    setFocus(x,y);
};
const pressUp = () => {
    press.isPress = false;
    press.moveX = 0;
    press.moveY = 0;
    press.startFocusX = 0;
    press.startFocusY = 0;
};

window.addEventListener("mousedown", (e) => {
    pressDown(e);
});
window.addEventListener("mousemove", (e) => {
    pressMove(e);
});
window.addEventListener("mouseup", (e) => {
    pressUp();
});
window.addEventListener("mouseout", (e) => {
    // pressUp();
});

window.addEventListener("touchstart", (e) => {
    pressDown(e.touches[0]);
});
window.addEventListener("touchmove", (e) => {
    pressMove(e.touches[0]);
});
window.addEventListener("touchend", (e) => {
    pressUp();
});

const setFocus = (willX = 0, willY = 0) => {
    // limitX = (map.width * focus.scale) - (size.ww * focus.scale) + ((1 - (1/focus.scale)) * map.width);

    let isOverX = focus.width - willX - size.ww < 0;
    let isOverY = focus.height - willY - size.wh < 0;

    let limitX = focus.width - size.ww - 1;
    let limitY = focus.height - size.wh - 1;

    let x = willX;
    let y = willY;

    if(willX <= 0) {
        x = 0;
    }
    if(isOverX) {
        x = limitX;
    }

    if(willY <= 0) {
        y = 0;
    }
    if(isOverY) {
        y = limitY;
    }

    focus.x = Math.round(x);
    focus.y = Math.round(y);

    const xPercent = perRound(focus.x / (focus.width - size.ww));
    const yPercent = perRound(focus.y / (focus.height - size.wh));
    focus.xPercent = xPercent;
    focus.yPercent = yPercent;

    const xPercentMap = perRound((focus.x + size.cx) / (focus.width));
    const yPercentMap = perRound((focus.y + size.cy) / (focus.height));
    focus.xPercentMap = xPercentMap;
    focus.yPercentMap = yPercentMap;

    focuscrosshead.innerHTML = `focus<br>x: ${focus.x} (${xPercent}%)<br>y: ${focus.y} (${yPercent}%)`;
};

const setFocusPercent = (xPercent, yPercent) => {
    const x = (map.width - size.ww)/100 * xPercent;
    const y = (map.height - size.wh)/100 * yPercent;
    setFocus(x,y);
};

const setFocusMapPercent = (xPercent, yPercent) => {
    const x = map.width/100 * xPercent - size.cx;
    const y = map.height/100 * yPercent - size.cy;
    setFocus(x,y);
};

const setScale = (scale) => {

    scale = scale <= 0.001 ? 0.001 : scale;

    const origin = {
        x: 1/focus.scale * focus.x,
        y: 1/focus.scale * focus.y,
    };

    origin.x = origin.x - (size.cx - (1/focus.scale * size.cx));
    origin.y = origin.y - (size.cy - (1/focus.scale * size.cy));

    let x = 0;
    let y = 0;


    if(mapSource.width * scale < size.ww) {
        scale = (size.ww+1) / (mapSource.width);
    }
    if(mapSource.height * scale < size.wh) {
        scale = (size.wh+1) / (mapSource.height);
    }
    x = ((origin.x - size.cx/scale) * scale) + (size.cx * scale);
    y = ((origin.y - size.cy/scale) * scale) + (size.cy * scale);

    console.log(`scale change! : ${focus.scale} => ${scale}`);
    focus.scale = scale;
    focus.width = mapSource.width * scale;
    focus.height = mapSource.height * scale;

    console.log(x,y);
    setFocus(x,y);
}

window.addEventListener("mousewheel" , (e) => {
    if(e.deltaY > 0) {
        setScale(focus.scale - 0.1);
    }else {
        setScale(focus.scale + 0.1);
    }
})

const mapPoints = [
    [46,35],
    [46,54],
    [60,57],
    [53,76],
];


setTimeout(() => {
    // setFocusPercent(5.5, 37);
    // setFocusMapPercent(14,42.5);
    // setFocusMapPercent(...mapPoints[0]);
    // setFocus(450,0);
    // setFocusMapPercent(40.5,0);
    // setFocusPercent(100,0);
    setFocusMapPercent(70.5,0);
},500);


const drawMap = () => {

    const d = {
        x: focus.x - map.x,
        y: focus.y - map.y,
        scale: focus.scale - map.scale,
    };

    const x = map.x + (d.x * map.power);
    const y = map.y + (d.y * map.power);
    const scale = map.scale + (d.scale * map.power);

    map.x = x;
    map.y = y;
    map.scale = scale;

    map.width = mapSource.width * map.scale;
    map.height = mapSource.height * map.scale;

    ctx.drawImage(mapSource, -map.x, -map.y, map.width , map.height);

};



















// cursor
const $cursor = document.querySelector(".cursor");
const $cursorPointer = document.querySelector(".cursor__pointer");
const $cursorVisual = document.querySelector(".cursor__visual");

window.addEventListener("mousemove", (e) => {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
});

window.addEventListener("mousedown" , () => {
    $cursor.classList.add("-press");
})
window.addEventListener("mouseup" , () => {
    $cursor.classList.remove("-press");
})

const drawCursor = () => {
    const dx = mouse.x - cursor.x;
    const dy = mouse.y - cursor.y;

    const x = (cursor.x + (dx * cursor.power));
    const y = (cursor.y + (dy * cursor.power));

    cursor.x = x;
    cursor.y = y;

    $cursorPointer.style.transform = `translate3d(${x}px,${y}px,0)`;
};

const draw = () => {
    requestAnimationFrame(draw);
    drawMap();
    drawCursor();
};

draw();

setTimeout(() => {
    // setFocus((map.width/2 - window.innerWidth/2) * -1, (map.height/2 - window.innerHeight/2) * -1)
},200);





</script>
</body>
</html>
