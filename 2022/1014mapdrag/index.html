<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js" integrity="sha512-WoO4Ih0CDOSLYafy22wZD/mcJ7k0ESLqtQsFa6zFKnEUrbtuGU+GkLtVhgt93xa2qewG5gKEC6CWlN8OaCTSVg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.3/gsap.min.js"></script>
<title>Document</title>
<link rel="stylesheet" href="./style.css">
</head>
<body>

<div id="app">
    <div class="focuscrosshead">
        <span>hello</span>
    </div>
    <div class="cursor">
        <span class="cursor__pointer">
            <span class="cursor__visual"></span>
        </span>
    </div>
    <div class="worldmap">
        <div class="mappoints">
            <button class="point point--1">화산섬 아래 반도</button>
            <button class="point point--2">간지나는 계곡</button>
            <button class="point point--3">산맥 정상</button>
            <button class="point point--4">남대륙 만</button>
            <button class="point point--5">사막산 정상</button>
        </div>
        <canvas></canvas>
    </div>
    <div id="modal-plate">
        <div class="modal-item type--video">
			<span class="modal__dimmed"></span>
			<div class="modal-item__wrap">
				<div class="modal__box">
					<button class="modal__close">닫기</button>
					<div class="modal__content">
						<div class="sourcebox">
							<iframe src="" frameborder="0" allowfullscreen=""></iframe>
						</div>
					</div>
				</div>
			</div>
		</div>
    </div>
</div>

<script src="./script.js"></script>
<script>


const YOUTUBE_KEY = "m8Ll-uML7Z4?start=14";
const $modalVideo = document.querySelector(".modal-item.type--video");
window.modal = {};
window.modal.video = new ModalObjectVideo($modalVideo, {youtube: YOUTUBE_KEY});

const perRound = (value) => {
    return (Math.round(value * 1000))/10;
}

const $app = document.querySelector("#app");
const $canvas = document.querySelector(".worldmap canvas");
const ctx = $canvas.getContext("2d");
const mapSource = new Image();

const $mappoints = document.querySelector(".mappoints");

const $crosshead = document.querySelector(".focuscrosshead");
const $crossheadtext = document.querySelector(".focuscrosshead span");


mapSource.src = "./map.jpg";

mapSource.onload = () => {
    focus.width = mapSource.width * focus.scale;
    focus.height = mapSource.height * focus.scale;
    map.width = focus.width;
    map.height = focus.height;

    ctx.canvas.width = size.ww;
    ctx.canvas.height = size.wh;

    setScale(focus.scale);
    setFocusPercent(50,50);
};

const size = {
    ww : window.innerWidth,
    wh : window.innerHeight,
    cx : window.innerWidth/2,
    cy : window.innerHeight/2,
};

const defaultValue = {
    mapPower: 0.2,
    cursorPower: 0.3,
    initScale: 0.1,
    limitUnderScale: 0.75,
    limitOverScale: 1.3,
    focusScale: 2.7,
};

const map = {
    x: 0,
    y: 0,
    scale: defaultValue.initScale,
    width: 0,
    height: 0,
    power: defaultValue.mapPower,
}

const focus = {
    x: 0,
    y: 0,
    scale: defaultValue.initScale,
    width: 0,
    height: 0,
    xPercent: 50,
    yPercent: 50,
    xPercentMap :50,
    yPercentMap :50,
    isFreeze: false,
};

const mouse = {
    x: 0,
    y: 0,
};

const cursor = {
    x: 0,
    y: 0,
    power: defaultValue.cursorPower,
}

const press = {
    isPress: false,
    time: 0,
    timer: null,

    startFocusX : 0,
    startFocusY : 0,
    startPressX: 0,
    startPressY: 0,
    moveX: 0,
    moveY: 0,
}








window.addEventListener("resize", () => {
    size.ww = window.innerWidth;
    size.wh = window.innerHeight;
    size.cx = window.innerWidth/2;
    size.cy = window.innerHeight/2;

    ctx.canvas.width = size.ww;
    ctx.canvas.height = size.wh;

    // setFocusPercent(focus.xPercent, focus.yPercent);
    // setFocusMapPercent(focus.xPercent, focus.yPercent);
    // setFocusMapPercent(14,42.5);
    // setFocusMapPercent(20,42.5);

    setFocusMapPercent(focus.xPercentMap, focus.yPercentMap);
    // setScale(focus.scale);

});

const pressDown = (e) => {
    if(focus.isFreeze) {
        return;
    }
    press.isPress = true;
    press.startPressX = e.clientX;
    press.startPressY = e.clientY || e.touches[0].clientY;
    press.startFocusX = focus.x;
    press.startFocusY = focus.y;
};
const pressMove = (e) => {
    if(!press.isPress) {
        return;
    }
    if(focus.isFreeze) {
        return;
    }

    press.moveX = e.clientX;
    press.moveY = e.clientY;

    const dx = press.moveX - press.startPressX;
    const dy = press.moveY - press.startPressY;

    const x = press.startFocusX - dx;
    const y = press.startFocusY - dy;

    setFocus(x,y);
};
const pressUp = () => {
    press.isPress = false;
    press.moveX = 0;
    press.moveY = 0;
    press.startFocusX = 0;
    press.startFocusY = 0;
};

window.addEventListener("mousedown", (e) => {
    pressDown(e);
});
window.addEventListener("mousemove", (e) => {
    pressMove(e);
});
window.addEventListener("mouseup", (e) => {
    pressUp();
});
window.addEventListener("mouseout", (e) => {
    // pressUp();
});

window.addEventListener("touchstart", (e) => {
    pressDown(e.touches[0]);
});
window.addEventListener("touchmove", (e) => {
    pressMove(e.touches[0]);
});
window.addEventListener("touchend", (e) => {
    pressUp();
});

const setFocus = (willX, willY) => {
    willX = willX === undefined ? focus.x : willX;
    willY = willY === undefined ? focus.y : willY;

    let isOverX = focus.width - willX - size.ww < 0;
    let isOverY = focus.height - willY - size.wh < 0;

    let limitX = focus.width - size.ww - 1;
    let limitY = focus.height - size.wh - 1;

    let x = willX;
    let y = willY;

    if(willX <= 0) {
        x = 0;
    }
    if(isOverX) {
        x = limitX;
    }

    if(willY <= 0) {
        y = 0;
    }
    if(isOverY) {
        y = limitY;
    }

    focus.x = Math.round(x);
    focus.y = Math.round(y);

    const xPercent = perRound(focus.x / (focus.width - size.ww));
    const yPercent = perRound(focus.y / (focus.height - size.wh));
    focus.xPercent = xPercent;
    focus.yPercent = yPercent;

    const xPercentMap = perRound((focus.x + size.cx) / (focus.width));
    const yPercentMap = perRound((focus.y + size.cy) / (focus.height));
    focus.xPercentMap = xPercentMap;
    focus.yPercentMap = yPercentMap;

    $crossheadtext.innerHTML = `focus<br>x: ${focus.x} (${xPercent}%)<br>y: ${focus.y} (${yPercent}%)`;
};

const setFocusPercent = (xPercent, yPercent) => {
    const x = (focus.width - size.ww)/100 * xPercent;
    const y = (focus.height - size.wh)/100 * yPercent;
    setFocus(x,y);
};

const setFocusMapPercent = (xPercent, yPercent) => {
    const x = focus.width/100 * xPercent - size.cx;
    const y = focus.height/100 * yPercent - size.cy;
    setFocus(x,y);
};

const setScale = (scale, power) => {

// [TODO] 항좀 정리하자 
    scale = scale <= 0.001 ? 0.001 : scale;

    const origin = {
        x: 1/focus.scale * focus.x,
        y: 1/focus.scale * focus.y,
    };

    origin.x = origin.x - (size.cx - (1/focus.scale * size.cx));
    origin.y = origin.y - (size.cy - (1/focus.scale * size.cy));

    if(mapSource.width * scale < size.ww) {
        scale = (size.ww+1) / (mapSource.width);
    }
    if(mapSource.height * scale < size.wh) {
        scale = (size.wh+1) / (mapSource.height);
    }

    let x = ((origin.x - size.cx/scale) * scale) + (size.cx * scale);
    let y = ((origin.y - size.cy/scale) * scale) + (size.cy * scale);

    focus.scale = scale;
    focus.width = mapSource.width * scale;
    focus.height = mapSource.height * scale;
    focus.x = x;
    focus.y = y;
}

window.addEventListener("mousewheel" , (e) => {

    if(e.deltaY > 0) {
        // 축소
        if(focus.scale > defaultValue.limitUnderScale) {
            setScale(focus.scale - 0.05);
        }
    }else {
        // 확대
        if(focus.scale < defaultValue.limitOverScale) {
            setScale(focus.scale + 0.05);
        }
    }

    setFocus();
});


const drawMap = () => {

    const d = {
        x: focus.x - map.x,
        y: focus.y - map.y,
        scale: focus.scale - map.scale,
    };

    const x = map.x + (d.x * map.power);
    const y = map.y + (d.y * map.power);
    const scale = map.scale + (d.scale * map.power);

    map.x = x;
    map.y = y;
    map.scale = scale;

    map.width = mapSource.width * map.scale;
    map.height = mapSource.height * map.scale;

    $mappoints.style.transform = `translate3d(${-x}px,${-y}px,0)`
    $mappoints.style.width = `${map.width}px`;
    $mappoints.style.height = `${map.height}px`;

    ctx.drawImage(mapSource, -map.x, -map.y, map.width , map.height);
};


















// 대충만들고
// cursor
const $cursor = document.querySelector(".cursor");
const $cursorPointer = document.querySelector(".cursor__pointer");
const $cursorVisual = document.querySelector(".cursor__visual");

window.addEventListener("mousemove", (e) => {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
    for(let i = 0, l = e.path.length; i < l; ++i) {
        if(e.path[i].tagName === "A" || e.path[i].tagName === "BUTTON") {
        // console.log('hoveR!');
            $cursor.classList.add("-hover");
            break;
        }
        $cursor.classList.remove("-hover");
    }
});
window.addEventListener("mousedown" , () => {
    $cursor.classList.add("-press");
});
window.addEventListener("mouseup" , () => {
    $cursor.classList.remove("-press");
});

const drawCursor = () => {
    const dx = mouse.x - cursor.x;
    const dy = mouse.y - cursor.y;

    const x = (cursor.x + (dx * cursor.power));
    const y = (cursor.y + (dy * cursor.power));

    cursor.x = x;
    cursor.y = y;

    $cursorPointer.style.transform = `translate3d(${x}px,${y}px,0)`;
};

const draw = () => {
    requestAnimationFrame(draw);
    drawMap();
    drawCursor();
};

draw();

const myPoints = [
    [46,35], // 화산섬 아래 반도
    [46,54], // 말라붙은 계곡
    [64,58], // 산맥 정상
    [53,76], // 남대륙 만
    [35,53], // 사막산 정상
];

const $mappoint_itmes = document.querySelectorAll(".mappoints .point");

const testAction = (xPercentMap,yPercentMap) => {
    map.power = 0.05;
    focus.x = map.x;
    focus.y = map.y;
    focus.scale = map.focusScale;
    setScale(2);
    setFocusMapPercent(xPercentMap,yPercentMap);
    $canvas.classList.add("-perspective");

    setTimeout(() => {
        modal.video.open({onClose: () => {
            setScale(defaultValue.limitUnderScale);
            $canvas.classList.remove("-perspective");
            setFocus();
            map.power = defaultValue.mapPower;
        }});
    },500);
};

[...$mappoint_itmes].forEach((item,i) => {
    item.addEventListener("click", () => {
        testAction(...myPoints[i]);
    });
});

const tl_init = gsap.timeline({paused: true});
tl_init.fromTo(document.body, {autoAlpha: 0}, {autoAlpha: 1, duration: 1, ease: "power1.in"},0.3);
tl_init.add(() => {
    map.power = 0.05;
    setScale(defaultValue.limitUnderScale);
    setTimeout(() => {
        map.power = defaultValue.mapPower;
        focus.isFreeze = false;
    },1000);
});

window.addEventListener("DOMContentLoaded", () => {
    tl_init.play();
    focus.isFreeze = true;
});


// dat
const guidev = {
    "중심 확인선 켜기": false,
    "직접 이동: 화산섬 아래 반도": () => {
        testAction(...myPoints[0]);
    },
    "직접 이동: 말라붙은 계곡": () => {
        testAction(...myPoints[1]);
    },
    "직접 이동: 산맥 정상": () => {
        testAction(...myPoints[2]);
    },
    "직접 이동: 남대륙 만": () => {
        testAction(...myPoints[3]);
    },
    "직접 이동: 사막산 정상": () => {
        testAction(...myPoints[4]);
    },

}
const gui = new dat.GUI();
const guiclose = gui.domElement.querySelector(".close-button");
let isOpen = localStorage.guiopen ? true : false;
guiclose.addEventListener("click", () => {
    isOpen = !isOpen;
    if(isOpen) {
        localStorage.setItem("guiopen", isOpen);
    }else {
        localStorage.removeItem("guiopen");
    }
});
isOpen ? gui.open() : gui.close();

const gui_mouse = gui.addFolder("mouse");
gui_mouse.add(mouse, "x").listen();
gui_mouse.add(mouse, "y").listen();
// gui_mouse.domElement.style.pointerEvents = "none";
// gui_mouse.open();

const gui_cursor = gui.addFolder("cursor");
gui_cursor.add(cursor, "x").listen();
gui_cursor.add(cursor, "y").listen();
// gui_cursor.domElement.style.pointerEvents = "none";
// gui_cursor.open();

const gui_focus = gui.addFolder("focus");
gui_focus.add(focus, "x").listen();
gui_focus.add(focus, "y").listen();
gui_focus.add(focus, "xPercent").listen();
gui_focus.add(focus, "yPercent").listen();
gui_focus.add(focus, "xPercentMap").listen();
gui_focus.add(focus, "yPercentMap").listen();
gui_focus.add(focus, "scale").step(0.0001).listen();
gui_focus.add(focus, "width").step(1).listen();
gui_focus.add(focus, "height").step(1).listen();
// gui_focus.open();

const gui_map = gui.addFolder("map");
gui_map.add(map, "x").listen();
gui_map.add(map, "y").listen();
gui_map.add(map, "scale").step(0.0001).listen();
gui_map.add(map, "width").step(1).listen();
gui_map.add(map, "height").step(1).listen();
gui_map.add(map, "power").listen();
// guiMap.add(map, "width");
// guiMap.add(map, "height");
// gui_map.domElement.style.pointerEvents = "none";
// gui_map.open();

const gui_press = gui.addFolder("press");
gui_press.add(press, "isPress").listen();
gui_press.add(press, "time").listen();
gui_press.add(press, "startFocusX").listen();
gui_press.add(press, "startFocusY").listen();
gui_press.add(press, "startPressX").listen();
gui_press.add(press, "startPressY").listen();
gui_press.add(press, "moveX").listen();
gui_press.add(press, "moveY").listen();
// gui_press.domElement.style.pointerEvents = "none";
// gui_press.open();


const gui_cancontrol = gui.addFolder("조작 가능");
gui_cancontrol.add(guidev, "중심 확인선 켜기").onFinishChange((now) => {
    $crosshead.classList[now ? "add" : "remove"]("-show");
});
gui_cancontrol.add(guidev, "직접 이동: 화산섬 아래 반도");
gui_cancontrol.add(guidev, "직접 이동: 말라붙은 계곡");
gui_cancontrol.add(guidev, "직접 이동: 산맥 정상");
gui_cancontrol.add(guidev, "직접 이동: 남대륙 만");
gui_cancontrol.add(guidev, "직접 이동: 사막산 정상");
gui_cancontrol.open();


</script>
</body>
</html>
